pipeline 
{ 
    parameters 
    {
      string(name: 'appName', defaultValue : 'taskManager', description: "Applicaton Name")
      string(name: 'GitUrl', defaultValue : 'https://github.com/AnitaPK/taskManager.git', description: "Git repository Url")
      string(name: 'GitBranch', defaultValue : 'main', description: "Git repository branch name")
    }
    agent 
    {
       kubernetes {
       yaml '''
        apiAPP_VERSION: v1
        kind: Pod
        spec:
          containers:
          - name: hadolint
            image: hadolint/hadolint:latest-debian
            resources:
              requests:
                memory: "100Mi"
                cpu: "50m"
              limits:
                memory: "300Mi"
                cpu: "200m"
            command:
            - cat
            tty: true
          - name: git-secret
            image: bitbucketpipelines/git-secrets-scan:latest
            resources:
              requests:
                memory: "100Mi"
                cpu: "50m"
              limits:
                memory: "300Mi"
                cpu: "200m"
            command:
            - cat
            tty: true
          - name: trufflehog
            image: trufflesecurity/trufflehog:latest
            resources:
              requests:
                memory: "100Mi"
                cpu: "50m"
              limits:
                memory: "300Mi"
                cpu: "200m"
            command:
            - cat
            tty: true
          - name: node
            image: node:19-alpine           
            tty: true
            command: ["/bin/sh"]
          - name: trivy
            image: aquasec/trivy:latest
            command:
            - cat
            tty: true
            volumeMounts:
              - mountPath: /var/run/docker.sock
                name: docker-sock
          - name: docker
            image: docker:latest
            resources:
              requests:
                memory: "10Mi"
                cpu: "10m"
              limits:
                memory: "300Mi"
                cpu: "200m"        
            command:
            - cat
            tty: true
            volumeMounts:
              - mountPath: /var/run/docker.sock
                name: docker-sock
          volumes:
          - name: docker-sock
            hostPath:
              path: /var/run/docker.sock
        '''
      }
    }
    stages 
    {       
        stage('Clone Application Repository') 
        {
            steps 
            {
                git branch: GitBranch, url: GitUrl
            }
        }

        stage('Git-Secret Scanning')
        {
            steps
            {
                script
                {
                    container('git-secret')
                    {
                        echo "Checking for any secrets stored in the repo using git-secrets"
                        sh '''#!/bin/sh
                            git-secrets --scan -r $PWD
                        '''
                    }
                }
            }
        }

        stage('hadolint Scanning') 
        {
            steps 
            {
                script
                {
                    container('hadolint') 
                    {
                        sh '''#!/bin/sh
                          hadolint $appName/Dockerfile | tee -a hadolint_lint.txt
                        '''
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'hadolint_lint.txt', onlyIfSuccessful: false
                    }
                }
            }
        }

        stage('Trufflehog Scanning')
        {
            steps
            {
                script
                {
                    container('trufflehog')
                    {
                        sh 'echo "trufflehog scanning started Staretd before build"'
                        echo "Checking for any secrets stored in the repo using trufflehog"
                        sh 'trufflehog filesystem --directory=$appName --debug --json > trufflehog_report.json'
                        sh 'cat trufflehog_report.json'
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'trufflehog_report.json', onlyIfSuccessful: true
                    }
                }
            }
        }

        stage('App Build') 
        {
            steps
            {
                script
                {   
                    container('node')
                    {
                      sh '''#!/bin/sh
                        cd $appName
                        rm yarn.lock package-lock.json
                        yarn install && yarn cache clean
                      '''
                    }
                }
                
            }
        }

        stage('Unit Test')
        {
          steps
           {
            script
                {
                    container('node')
                    {
                        try
                        {
                            sh '''#!/bin/sh
                              cd $appName
                              yarn add nyc --dev
                              npm run coverage
                            '''
                        }
                        catch (exc)
                        {
                            echo 'Tests failed'
                            currentBuild.result = 'UNSTABLE'
                        }
                    }
                }
            }
        }

        stage('Dependency Check') 
        {
          steps 
            {   
                dependencyCheck additionalArguments: "--cveValidForHours 48 --disableYarnAudit --disableNodeAudit --disableNodeAudit --prettyPrint --scan $appName --format ALL ${fileExists('$appName/owasp-suppression.xml') ? "--suppression $appName/owasp-suppression.xml" : ""} --disableAssembly", odcInstallation: 'dependency-check-v7.1.1'
                dependencyCheckPublisher pattern: ''
                archiveArtifacts allowEmptyArchive: true, artifacts: '**/dependency-check-report.*', onlyIfSuccessful: false
            }
        }
        stage('Build Docker Image') 
        {
            steps 
            {   
                script
                {
                    container('docker') 
                    {
                        sh 'ls -lrt'
                        sh 'docker build --network=host -t taskmanager:latest $appName/.'
                    }
                }
            }
        }
        stage("Scan Docker Image")
        {
            steps
            {
                container('trivy')
                {
                    script 
                    {
                        sh  'trivy image -f json -o trivy-results.json --exit-code 1 --severity CRITICAL,HIGH,MEDIUM,LOW taskmanager:latest' 
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'trivy-results.json', onlyIfSuccessful: false                       
                    }
                    
                }
            }
        }
    }
}
